<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBOM Play - Statistics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script defer data-domain="cyfinoid.github.io" src="https://plausible.io/js/script.outbound-links.js"></script>
<script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>

</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-cubes me-2"></i>SBOM Play
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">Analysis</a>
                <a class="nav-link active" href="stats.html">Stats</a>
                <a class="nav-link" href="license-compliance.html">License</a>
                <a class="nav-link" href="vuln.html">Vulnerabilities</a>
                <a class="nav-link" href="deps.html">Dependencies</a>
                <a class="nav-link" href="settings.html">
                    <i class="fas fa-cog"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1>üìä Statistics Dashboard</h1>
                        <p class="text-muted">High-level overview of all your SBOM analyses</p>
                    </div>
                    <div>
                        <a href="index.html" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Analysis
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Overview -->
        <div id="dashboardOverview" class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Overview
                </h5>
            </div>
            <div class="card-body">
                <div id="overviewContent">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading dashboard data...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats Cards -->
        <div id="statsCards" class="row mb-4">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <!-- No Data Section -->
        <div id="noDataSection" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>No Data Available
                </h5>
            </div>
            <div class="card-body text-center">
                <i class="fas fa-database fa-3x text-muted mb-3"></i>
                <h5>No Stored Analyses Found</h5>
                <p class="text-muted">
                    You haven't analyzed any organizations yet, or all data has been cleared.
                </p>
                <a href="index.html" class="btn btn-primary">
                    <i class="fas fa-play me-2"></i>Start Your First Analysis
                </a>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container">
            <div class="row">
                <!-- First Column: SBOM Play Tool -->
                <div class="col-md-4">
                    <h6 class="text-primary">SBOM Play</h6>
                    <p class="text-muted small mb-3">
                        A client-side tool for analyzing Software Bill of Materials from GitHub organizations and users.
                        All processing happens in your browser for maximum privacy and security.
                    </p>
                    <p class="text-muted small mb-0">
                        <strong>Privacy-First:</strong> All processing happens in your browser<br>
                        <strong>No Server Required:</strong> Works entirely client-side<br>
                        <strong>Persistent Storage:</strong> Results saved in browser storage<br>
                        <strong>Rate Limit Aware:</strong> Handles GitHub API limits intelligently
                    </p>
                </div>
                
                <!-- Second Column: Links -->
                <div class="col-md-4">
                    <h6 class="text-primary">Resources</h6>
                    <div class="d-flex flex-column gap-2">
                        <a href="https://cyfinoid.com/" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-globe me-1"></i>Website
                        </a>
                        <a href="https://cyfinoid.com/blog/" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-blog me-1"></i>Blog
                        </a>
                        <a href="https://cyfinoid.com/trainings/#upcoming-trainings" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-graduation-cap me-1"></i>Upcoming Trainings
                        </a>
                        <a href="https://cyfinoid.com/opensource-by-cyfinoid/" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fab fa-github me-1"></i>Open Source by Cyfinoid
                        </a>
                    </div>
                </div>
                
                <!-- Third Column: Company Information -->
                <div class="col-md-4">
                    <h6 class="text-primary">About Cyfinoid Research</h6>
                    <p class="text-muted small mb-3">
                        Leading cybersecurity research company specializing in software supply chain security, 
                        Android security, and cloud security. Our expertise spans across comprehensive software 
                        supply chain protection.
                    </p>
                </div>
            </div>
            <hr class="my-3">
            <div class="text-center">
                <small class="text-muted">
                    ¬© 2025 Cyfinoid Research. All rights reserved. | 
                    <a href="https://github.com/cyfinoid/sbomplay" target="_blank" class="text-muted">
                        <i class="fab fa-github me-1"></i>View on GitHub
                    </a>
                </small>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/github-client.js"></script>
    <script src="js/sbom-processor.js"></script>
    <script src="js/license-processor.js"></script>
    <script src="js/osv-service.js"></script>
    <script src="js/storage-manager.js"></script>
    <script src="js/view-manager.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Dashboard app for the combined view
        class DashboardApp {
            constructor() {
                this.storageManager = new StorageManager();
                this.viewManager = new ViewManager();
                this.init();
            }

            init() {
                this.loadDashboardData();
            }

            /**
             * Load and display dashboard data
             */
            loadDashboardData() {
                const storageInfo = this.storageManager.getStorageInfo();
                console.log('üîç Stats Page - Storage Info:', storageInfo);
                
                if (storageInfo.organizationsCount === 0) {
                    console.log('üîç Stats Page - No organizations found, showing no data section');
                    document.getElementById('dashboardOverview').style.display = 'none';
                    document.getElementById('statsCards').style.display = 'none';
                    document.getElementById('noDataSection').style.display = 'block';
                    return;
                }

                // Show dashboard sections
                document.getElementById('dashboardOverview').style.display = 'block';
                document.getElementById('statsCards').style.display = 'block';
                document.getElementById('noDataSection').style.display = 'none';

                // Load combined data
                const combinedData = this.storageManager.getCombinedData();
                console.log('üîç Stats Page - Combined Data:', combinedData);
                
                if (combinedData) {
                    console.log('üîç Stats Page - Displaying dashboard with data');
                    this.displayDashboardOverview(combinedData);
                    this.displayStatsCards(combinedData);
                } else {
                    console.log('üîç Stats Page - No combined data available, showing no data message');
                    this.showNoDataMessage();
                }
            }

            /**
             * Display dashboard overview
             */
            displayDashboardOverview(data) {
                const content = document.getElementById('overviewContent');
                
                console.log('üîç Stats Page - Display Dashboard Data:', data);
                console.log('üîç Stats Page - Data structure:', {
                    repositories: data.data.repositories,
                    dependencies: data.data.dependencies,
                    vulnerabilities: data.data.vulnerabilities,
                    licenses: data.data.licenses,
                    allDependencies: data.data.allDependencies,
                    allRepositories: data.data.allRepositories,
                    vulnerabilityAnalysis: data.data.vulnerabilityAnalysis,
                    licenseAnalysis: data.data.licenseAnalysis
                });
                
                // Calculate high-level stats
                const totalRepos = data.data.allRepositories?.length || 0;
                const totalDeps = data.data.allDependencies?.length || 0;
                
                // Extract vulnerabilities from vulnerabilityAnalysis
                let totalVulns = 0;
                if (data.data.vulnerabilityAnalysis && data.data.vulnerabilityAnalysis.vulnerableDependencies) {
                    totalVulns = data.data.vulnerabilityAnalysis.vulnerableDependencies.reduce((total, dep) => {
                        return total + (dep.vulnerabilities?.length || 0);
                    }, 0);
                }
                
                // Extract licenses from licenseAnalysis
                let totalLicenses = 0;
                if (data.data.licenseAnalysis && data.data.licenseAnalysis.summary) {
                    totalLicenses = data.data.licenseAnalysis.summary.totalDependencies || 0;
                }

                console.log('üîç Stats Page - Calculated totals:', {
                    totalRepos,
                    totalDeps,
                    totalVulns,
                    totalLicenses
                });

                const html = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üìä Combined Analysis Summary</h6>
                            <p class="text-muted small mb-3">
                                Aggregated data from all analyzed organizations
                            </p>
                        </div>
                        <div class="col-md-6 text-end">
                            <a href="license-compliance.html" class="btn btn-outline-primary btn-sm me-2">
                                <i class="fas fa-file-contract me-1"></i>License Details
                            </a>
                            <a href="vuln.html" class="btn btn-outline-warning btn-sm me-2">
                                <i class="fas fa-shield-alt me-1"></i>Vulnerability Details
                            </a>
                            <a href="deps.html" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-cubes me-1"></i>Dependency Details
                            </a>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary">${totalRepos}</h4>
                                <small class="text-muted">Repositories</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success">${totalDeps}</h4>
                                <small class="text-muted">Dependencies</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning">${totalVulns}</h4>
                                <small class="text-muted">Vulnerabilities</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info">${totalLicenses}</h4>
                                <small class="text-muted">Licenses</small>
                            </div>
                        </div>
                    </div>
                `;
                
                content.innerHTML = html;
            }

            /**
             * Display stats cards
             */
            displayStatsCards(data) {
                const statsContainer = document.getElementById('statsCards');
                
                // Calculate additional stats
                const topLanguages = this.getTopLanguages(data);
                const topVulnerabilities = this.getTopVulnerabilities(data);
                const licenseCompliance = this.getLicenseCompliance(data);

                const html = `
                    <div class="row gy-3">
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-code me-2"></i>Top Languages</h6>
                                </div>
                                <div class="card-body">
                                    ${this.renderTopLanguages(topLanguages)}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Critical Issues</h6>
                                </div>
                                <div class="card-body">
                                    ${this.renderTopVulnerabilities(topVulnerabilities)}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-file-contract me-2"></i>License Status</h6>
                                </div>
                                <div class="card-body">
                                    ${this.renderLicenseCompliance(licenseCompliance)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                statsContainer.innerHTML = html;
            }

            /**
             * Get top languages from data
             */
            getTopLanguages(data) {
                console.log('üîç Stats Page - Getting top languages from data:', data.data.languageStats);
                
                if (!data.data.languageStats) {
                    console.log('üîç Stats Page - No language stats available');
                    return [];
                }
                
                const languages = Object.entries(data.data.languageStats)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([lang, count]) => ({ language: lang, count }));
                
                console.log('üîç Stats Page - Top languages:', languages);
                return languages;
            }

            /**
             * Get top vulnerabilities from data
             */
            getTopVulnerabilities(data) {
                console.log('üîç Stats Page - Getting top vulnerabilities from data:', data.data.vulnerabilityAnalysis);
                
                if (!data.data.vulnerabilityAnalysis || !data.data.vulnerabilityAnalysis.vulnerableDependencies) {
                    console.log('üîç Stats Page - No vulnerability analysis available');
                    return [];
                }
                
                const vulnCounts = {};
                data.data.vulnerabilityAnalysis.vulnerableDependencies.forEach(dep => {
                    if (dep.vulnerabilities) {
                        dep.vulnerabilities.forEach(vuln => {
                            const severity = vuln.severity || 'unknown';
                            vulnCounts[severity] = (vulnCounts[severity] || 0) + 1;
                        });
                    }
                });
                
                const vulnerabilities = Object.entries(vulnCounts)
                    .sort(([,a], [,b]) => b - a)
                    .map(([severity, count]) => ({ severity, count }));
                
                console.log('üîç Stats Page - Top vulnerabilities:', vulnerabilities);
                return vulnerabilities;
            }

            /**
             * Get license compliance stats
             */
            getLicenseCompliance(data) {
                console.log('üîç Stats Page - Getting license compliance from data:', data.data.licenseAnalysis);
                
                if (!data.data.licenseAnalysis || !data.data.licenseAnalysis.summary) {
                    console.log('üîç Stats Page - No license analysis available');
                    return { total: 0, compliant: 0, nonCompliant: 0 };
                }
                
                const summary = data.data.licenseAnalysis.summary;
                const total = summary.totalDependencies || 0;
                const compliant = summary.licensedDependencies || 0;
                
                const result = {
                    total,
                    compliant,
                    nonCompliant: total - compliant
                };
                
                console.log('üîç Stats Page - License compliance:', result);
                return result;
            }

            /**
             * Render top languages
             */
            renderTopLanguages(languages) {
                if (languages.length === 0) {
                    return '<p class="text-muted small">No language data available</p>';
                }
                
                return languages.map(lang => 
                    `<div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">${lang.language}</span>
                        <span class="badge bg-primary">${lang.count}</span>
                    </div>`
                ).join('');
            }

            /**
             * Render top vulnerabilities
             */
            renderTopVulnerabilities(vulnerabilities) {
                if (vulnerabilities.length === 0) {
                    return '<p class="text-muted small">No vulnerability data available</p>';
                }
                
                const severityColors = {
                    'critical': 'danger',
                    'high': 'warning',
                    'medium': 'info',
                    'low': 'secondary',
                    'unknown': 'light',
                    'CRITICAL': 'danger',
                    'HIGH': 'warning',
                    'MEDIUM': 'info',
                    'LOW': 'secondary',
                    'UNKNOWN': 'light'
                };
                
                return vulnerabilities.map(vuln => {
                    const severity = vuln.severity || 'unknown';
                    const color = severityColors[severity] || 'light';
                    return `<div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small text-capitalize">${severity.toLowerCase()}</span>
                        <span class="badge bg-${color}">${vuln.count}</span>
                    </div>`;
                }).join('');
            }

            /**
             * Render license compliance
             */
            renderLicenseCompliance(compliance) {
                if (compliance.total === 0) {
                    return '<p class="text-muted small">No license data available</p>';
                }
                
                const compliantPercent = compliance.total > 0 ? 
                    ((compliance.compliant / compliance.total) * 100).toFixed(1) : 0;
                
                return `
                    <div class="text-center mb-3">
                        <h4 class="text-${compliantPercent >= 80 ? 'success' : compliantPercent >= 60 ? 'warning' : 'danger'}">${compliantPercent}%</h4>
                        <small class="text-muted">Compliant</small>
                    </div>
                    <div class="row text-center">
                        <div class="col-6">
                            <small class="text-success">${compliance.compliant} Compliant</small>
                        </div>
                        <div class="col-6">
                            <small class="text-danger">${compliance.nonCompliant} Issues</small>
                        </div>
                    </div>
                `;
            }

            /**
             * Show no data message
             */
            showNoDataMessage() {
                document.getElementById('dashboardOverview').style.display = 'none';
                document.getElementById('statsCards').style.display = 'none';
                document.getElementById('noDataSection').style.display = 'block';
            }

            /**
             * Show alert
             */
            showAlert(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                const container = document.querySelector('.container');
                container.insertBefore(alertDiv, container.firstChild);
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        }

        // Initialize the dashboard app
        let dashboardApp;
        document.addEventListener('DOMContentLoaded', () => {
            dashboardApp = new DashboardApp();
        });
    </script>
</body>
</html> 